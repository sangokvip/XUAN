# 域名更新指南：从 diviners.pro 到 diviners.net

## 🎯 问题描述

### 现象：
- 管理员后台已修改网站URL设置
- 前台仍然跳转到旧域名 diviners.pro
- 点击按钮和链接仍指向旧域名

### 根本原因：
网站中存在多个地方定义和使用域名，仅修改管理员后台设置是不够的。

## 🔍 问题分析

### 域名使用的位置：
1. **配置文件**：`config/site_config.php` 中硬编码了旧域名
2. **数据库设置**：`settings` 表中的 `site_url` 设置
3. **常量定义**：`SITE_URL` 常量的定义
4. **其他数据**：数据库中可能包含旧域名的链接

### 优先级问题：
配置文件中的 `SITE_URL` 常量优先级高于数据库设置，导致管理员后台的修改不生效。

## ✅ 解决方案

### 1. 修复配置文件
**文件**：`config/site_config.php`

**修改前**：
```php
define('SITE_URL', 'https://diviners.pro');
```

**修改后**：
```php
define('SITE_URL', 'https://diviners.net');
```

### 2. 运行域名更新脚本
**脚本**：`update_domain_to_diviners_net.php`

**功能**：
- 更新数据库中的 `site_url` 设置
- 检查并更新其他包含旧域名的设置
- 更新数据库中的相关数据记录
- 清理缓存文件
- 验证更新结果

## 🔧 具体修复步骤

### 步骤1：上传修复文件
```
config/site_config.php (已修复配置文件)
update_domain_to_diviners_net.php (域名更新脚本)
```

### 步骤2：运行更新脚本
访问：`https://diviners.net/update_domain_to_diviners_net.php`

### 步骤3：验证修复结果
1. **检查首页链接**：确认所有链接指向新域名
2. **测试导航菜单**：确认菜单链接正确
3. **测试登录跳转**：确认登录后跳转正确
4. **检查邮件链接**：确认邮件中的链接使用新域名

## 📊 更新内容详情

### 1. 配置文件更新
- ✅ `config/site_config.php` - 主配置文件
- ✅ 清理相关缓存文件

### 2. 数据库更新
- ✅ `settings` 表的 `site_url` 设置
- ✅ 其他包含旧域名的设置项
- ✅ 相关数据表中的链接记录

### 3. 检查的数据表
- `reader_registration_links` - 注册链接
- `invitation_links` - 邀请链接
- `admin_messages` - 管理员消息
- `contact_messages` - 联系留言

### 4. 验证项目
- SITE_URL 常量值
- 数据库设置值
- getSetting() 函数返回值

## 🛠️ 技术原理

### 域名配置的优先级：
1. **配置文件常量**：`config/site_config.php` 中的 `SITE_URL`
2. **数据库设置**：`settings` 表中的 `site_url`
3. **默认值**：代码中的默认值

### 为什么管理员后台修改不生效：
- 管理员后台只修改了数据库设置
- 但配置文件中的常量优先级更高
- 代码优先使用常量值，忽略数据库设置

### 正确的修复方法：
- 同时更新配置文件和数据库设置
- 确保两者保持一致
- 清理可能的缓存

## 🔒 安全注意事项

### 1. 备份重要数据
- 在执行更新前备份数据库
- 备份重要配置文件

### 2. 权限控制
- 更新脚本需要管理员权限
- 限制脚本的访问权限

### 3. 验证更新
- 全面测试网站功能
- 检查所有链接和跳转

## 📱 测试清单

### 前台功能测试：
- [ ] 首页导航链接
- [ ] 占卜师列表页面
- [ ] 占卜师详情页面
- [ ] 用户注册/登录
- [ ] 联系我们页面

### 后台功能测试：
- [ ] 管理员登录
- [ ] 占卜师后台登录
- [ ] 用户中心访问
- [ ] 邮件链接功能

### 特殊功能测试：
- [ ] 注册链接生成
- [ ] 邀请链接功能
- [ ] 密码重置邮件
- [ ] 系统通知邮件

## 🚀 部署后的优化

### 1. SEO优化
- 设置301重定向从旧域名到新域名
- 更新搜索引擎提交的sitemap
- 通知搜索引擎域名变更

### 2. 外部服务更新
- 更新第三方服务的回调URL
- 更新API接口的域名配置
- 更新CDN或反向代理配置

### 3. 监控和维护
- 监控旧域名的访问情况
- 检查是否有遗漏的旧域名引用
- 定期验证新域名的功能正常

## 📁 相关文件

### 修复文件：
```
config/site_config.php (配置文件修复)
update_domain_to_diviners_net.php (域名更新脚本)
DOMAIN_UPDATE_GUIDE.md (更新指南)
```

### 检查文件：
```
includes/header.php (导航链接)
includes/functions.php (URL生成函数)
auth/login.php (登录跳转)
admin/generate_reader_link.php (注册链接生成)
```

## 🎯 总结

这次域名更新解决了配置文件和数据库设置不一致的问题：

### ✅ 问题解决：
- **配置文件优先级**：修复了配置文件中的硬编码域名
- **数据库一致性**：确保数据库设置与配置文件一致
- **全面更新**：检查并更新了所有相关数据

### ✅ 预防措施：
- **统一配置**：建立统一的域名配置管理
- **动态读取**：优先从数据库读取可配置的设置
- **定期检查**：定期检查配置的一致性

### ✅ 最佳实践：
- **配置分离**：将可变配置与固定配置分离
- **优先级明确**：明确各种配置的优先级
- **全面测试**：域名变更后进行全面功能测试

现在网站应该完全使用新域名 diviners.net，所有链接和跳转都会指向正确的域名！
