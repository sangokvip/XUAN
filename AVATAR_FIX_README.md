# 头像显示修复说明

## 修复的问题

### 1. 占卜师默认头像显示问题
- **问题**：readers页面和index页面无法显示占卜师默认头像
- **原因**：代码中没有根据性别正确设置默认头像路径
- **解决方案**：根据占卜师性别自动选择对应的默认头像

### 2. 用户默认头像显示问题
- **问题**：部分页面用户头像显示逻辑不完整
- **原因**：没有根据用户性别正确设置默认头像
- **解决方案**：统一用户头像显示逻辑

## 默认头像规则

### 占卜师头像
- **男性占卜师**：`img/tm.jpg`
- **女性占卜师**：`img/tf.jpg`
- **优先级**：photo_circle > photo > 性别默认头像

### 用户头像
- **男性用户**：`img/nm.jpg`
- **女性用户**：`img/nf.jpg`
- **优先级**：自定义头像 > 性别默认头像

### 特殊情况
- **匿名评论**：`img/anonymous.jpg`
- **性别未知**：默认使用男性头像

## 修改的文件

### 占卜师头像相关
1. **readers.php** - 修复占卜师列表页头像显示
2. **index.php** - 修复首页推荐占卜师头像显示
3. **reader.php** - 修复占卜师详情页头像显示
4. **search.php** - 修复搜索页面占卜师头像显示
5. **tag_readers.php** - 修复标签页面占卜师头像显示

### 用户头像相关
6. **user/browse_history.php** - 修复浏览记录中占卜师头像显示
7. **user/index.php** - 修复用户中心浏览记录头像显示
8. **user/upload_avatar.php** - 修复头像上传页面当前头像显示
9. **reader.php** - 修复评论区用户头像显示

## 技术实现

### 头像选择逻辑
```php
// 占卜师头像
$photoSrc = '';
if (!empty($reader['photo_circle'])) {
    $photoSrc = $reader['photo_circle'];
} elseif (!empty($reader['photo'])) {
    $photoSrc = $reader['photo'];
} else {
    // 根据性别使用默认头像
    $photoSrc = ($reader['gender'] === 'female') ? 'img/tf.jpg' : 'img/tm.jpg';
}

// 用户头像
$avatarSrc = '';
if (!empty($user['avatar'])) {
    $avatarSrc = $user['avatar'];
} else {
    // 根据性别使用默认头像
    $avatarSrc = ($user['gender'] === 'female') ? 'img/nf.jpg' : 'img/nm.jpg';
}
```

### 错误处理
- 添加了`onerror`事件处理，当图片加载失败时显示备用图标
- 使用`style="display: none"`隐藏备用元素，只在需要时显示

## 文件路径处理

### 相对路径规则
- **根目录页面**：直接使用`img/xxx.jpg`
- **子目录页面**：使用`../img/xxx.jpg`
- **已有路径前缀**：保持原有路径不变

### 路径安全性
- 所有输出都使用`h()`函数进行HTML转义
- 避免路径注入攻击

## 测试建议

### 占卜师头像测试
1. 检查readers页面占卜师头像显示
2. 检查index页面推荐占卜师头像显示
3. 检查reader详情页头像显示
4. 测试男性和女性占卜师的默认头像
5. 验证有自定义头像的占卜师显示正常

### 用户头像测试
1. 检查用户中心头像显示
2. 检查评论区用户头像显示
3. 检查浏览记录中头像显示
4. 测试男性和女性用户的默认头像
5. 验证头像上传功能正常

### 错误处理测试
1. 测试图片文件不存在时的显示效果
2. 测试网络错误时的备用显示
3. 验证匿名评论的头像显示

## 注意事项

1. **文件存在性**：确保所有默认头像文件存在于`img/`目录
2. **权限设置**：确保头像文件具有正确的读取权限
3. **缓存清理**：修改后可能需要清理浏览器缓存
4. **移动端适配**：所有修改都考虑了移动端显示效果
5. **性能优化**：避免重复的文件存在性检查

## 默认头像文件清单

确保以下文件存在于`img/`目录：
- `tm.jpg` - 男性占卜师默认头像
- `tf.jpg` - 女性占卜师默认头像  
- `nm.jpg` - 男性用户默认头像
- `nf.jpg` - 女性用户默认头像
- `anonymous.jpg` - 匿名用户头像（如果需要）
