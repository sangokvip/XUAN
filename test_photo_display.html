<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>照片显示测试</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .test-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .test-photo {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
            margin: 10px auto;
            display: block;
            border: 3px solid #d4af37;
        }
        
        .test-photo-large {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin: 10px auto;
            display: block;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .path-display {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            word-break: break-all;
            margin: 5px 0;
        }
        
        .status-good { color: #28a745; }
        .status-bad { color: #dc3545; }
        .status-warning { color: #ffc107; }
        
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>📸 占卜师照片显示测试</h1>
        
        <div class="info">
            <h3>🎯 测试目的</h3>
            <p>验证占卜师照片在前台页面的显示效果，确保路径修复后照片能正常显示。</p>
        </div>

        <!-- 路径格式测试 -->
        <div class="test-section">
            <h2>🔍 路径格式测试</h2>
            <p>测试不同路径格式的照片显示效果：</p>
            
            <div class="test-grid">
                <div class="test-card">
                    <h4>正确格式</h4>
                    <img src="uploads/photos/test.jpg" alt="测试照片" class="test-photo" 
                         onerror="this.src='img/tm.jpg'; this.nextElementSibling.innerHTML='❌ 文件不存在';">
                    <div class="status-good">✅ 应该显示</div>
                    <div class="path-display">uploads/photos/test.jpg</div>
                </div>
                
                <div class="test-card">
                    <h4>错误格式1</h4>
                    <img src="../uploads/photos/test.jpg" alt="测试照片" class="test-photo"
                         onerror="this.src='img/tm.jpg'; this.nextElementSibling.innerHTML='❌ 路径错误';">
                    <div class="status-bad">❌ 不应该显示</div>
                    <div class="path-display">../uploads/photos/test.jpg</div>
                </div>
                
                <div class="test-card">
                    <h4>错误格式2</h4>
                    <img src="/uploads/photos/test.jpg" alt="测试照片" class="test-photo"
                         onerror="this.src='img/tm.jpg'; this.nextElementSibling.innerHTML='❌ 路径错误';">
                    <div class="status-bad">❌ 不应该显示</div>
                    <div class="path-display">/uploads/photos/test.jpg</div>
                </div>
                
                <div class="test-card">
                    <h4>默认头像</h4>
                    <img src="img/tm.jpg" alt="默认头像" class="test-photo">
                    <div class="status-good">✅ 默认头像</div>
                    <div class="path-display">img/tm.jpg</div>
                </div>
            </div>
        </div>

        <!-- 实际照片测试 -->
        <div class="test-section">
            <h2>👥 实际占卜师照片测试</h2>
            <p>以下是一些常见的照片路径示例：</p>
            
            <div class="test-grid">
                <div class="test-card">
                    <h4>男性默认头像</h4>
                    <img src="img/tm.jpg" alt="男性默认" class="test-photo-large">
                    <div class="status-good">✅ 正常显示</div>
                    <div class="path-display">img/tm.jpg</div>
                </div>
                
                <div class="test-card">
                    <h4>女性默认头像</h4>
                    <img src="img/tf.jpg" alt="女性默认" class="test-photo-large">
                    <div class="status-good">✅ 正常显示</div>
                    <div class="path-display">img/tf.jpg</div>
                </div>
                
                <div class="test-card">
                    <h4>上传的照片示例</h4>
                    <img src="uploads/photos/sample.jpg" alt="上传照片" class="test-photo-large"
                         onerror="this.src='img/tm.jpg'; this.nextElementSibling.innerHTML='使用默认头像';">
                    <div class="status-warning">⚠️ 如果存在则显示</div>
                    <div class="path-display">uploads/photos/sample.jpg</div>
                </div>
            </div>
        </div>

        <!-- 修复效果验证 -->
        <div class="test-section">
            <h2>🔧 修复效果验证</h2>
            
            <div class="success">
                <h4>✅ 已完成的修复</h4>
                <ul>
                    <li><strong>前台页面路径处理</strong>: 所有前台页面都已更新照片路径处理逻辑</li>
                    <li><strong>路径清理函数</strong>: 添加了cleanPhotoPath()和getReaderPhotoUrl()函数</li>
                    <li><strong>数据库路径修复</strong>: 提供了fix_photo_paths.php脚本清理错误路径</li>
                    <li><strong>后台上传优化</strong>: 确保新上传的照片路径格式正确</li>
                </ul>
            </div>
            
            <div class="info">
                <h4>📋 修复的页面</h4>
                <ul>
                    <li>✅ <strong>reader.php</strong> - 占卜师详情页</li>
                    <li>✅ <strong>index.php</strong> - 首页推荐占卜师</li>
                    <li>✅ <strong>readers.php</strong> - 占卜师列表页</li>
                    <li>✅ <strong>search.php</strong> - 搜索结果页</li>
                    <li>✅ <strong>tag_readers.php</strong> - 标签占卜师页</li>
                    <li>✅ <strong>reader/settings.php</strong> - 后台设置页</li>
                </ul>
            </div>
        </div>

        <!-- 测试步骤 -->
        <div class="test-section">
            <h2>🧪 测试步骤</h2>
            <ol>
                <li><strong>运行路径修复脚本</strong>: 访问 <a href="fix_photo_paths.php" target="_blank">fix_photo_paths.php</a></li>
                <li><strong>上传新照片</strong>: 在占卜师后台上传一张新照片</li>
                <li><strong>检查前台显示</strong>: 访问占卜师详情页查看照片是否正常显示</li>
                <li><strong>检查列表页</strong>: 在首页和占卜师列表页查看照片</li>
                <li><strong>验证搜索结果</strong>: 搜索该占卜师，查看搜索结果中的照片</li>
            </ol>
        </div>

        <!-- 故障排除 -->
        <div class="test-section">
            <h2>🔧 故障排除</h2>
            
            <h4>如果照片仍然不显示：</h4>
            <ol>
                <li><strong>检查文件权限</strong>: 确保uploads/photos/目录有正确的读写权限</li>
                <li><strong>检查文件路径</strong>: 使用 <a href="debug_photo_paths.php" target="_blank">debug_photo_paths.php</a> 查看详细信息</li>
                <li><strong>清理浏览器缓存</strong>: 强制刷新页面 (Ctrl+F5)</li>
                <li><strong>检查数据库</strong>: 确认数据库中的路径格式正确</li>
                <li><strong>重新上传照片</strong>: 在后台重新上传一次照片</li>
            </ol>
            
            <h4>常见问题：</h4>
            <ul>
                <li><strong>404错误</strong>: 文件路径不正确或文件不存在</li>
                <li><strong>权限错误</strong>: 服务器无法访问照片文件</li>
                <li><strong>缓存问题</strong>: 浏览器显示的是旧的缓存图片</li>
                <li><strong>路径格式</strong>: 数据库中保存的路径格式不正确</li>
            </ul>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <a href="index.php" class="btn" style="display: inline-block; padding: 10px 20px; background: #d4af37; color: white; text-decoration: none; border-radius: 5px;">
                🏠 返回首页测试
            </a>
            <a href="readers.php" class="btn" style="display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 5px; margin-left: 10px;">
                👥 查看占卜师列表
            </a>
        </div>
    </div>

    <script>
        // 检测图片加载状态
        document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('img');
            let loadedCount = 0;
            let errorCount = 0;
            
            images.forEach(img => {
                if (img.complete) {
                    if (img.naturalWidth === 0) {
                        errorCount++;
                    } else {
                        loadedCount++;
                    }
                } else {
                    img.addEventListener('load', () => loadedCount++);
                    img.addEventListener('error', () => errorCount++);
                }
            });
            
            setTimeout(() => {
                console.log(`图片加载统计: 成功 ${loadedCount}, 失败 ${errorCount}, 总计 ${images.length}`);
            }, 2000);
        });
    </script>
</body>
</html>
